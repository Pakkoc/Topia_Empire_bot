# <a:DH_MINA_09:1462814893546934418> Forge 상점 시스템

> ## <a:DH_MINA_04:1462813052138291282> 개요 및 목적
> ```- 서버 멤버가 활동형/수익형 화폐로 아이템을 구매할 수 있는 상점
> - 역할선택권, 세금감면권, 금고등급 등 다양한 아이템 타입 지원
> - 디스코드 채널에 통합 상점 패널 설치 가능```

---

> ## 1단계: 아이템 타입 분류
> ### <a:DH_MINA_03:1462813029577130200> 일반 아이템 (custom)
> * **일반**: 커스텀 아이템으로 자유롭게 생성 가능
> <a:DH_MINA_03:1462813029577130200> 역할선택권 기능과 조합하여 다양한 용도로 활용

> ### <a:DH_MINA_03:1462813029577130200> 시스템 아이템
> * **세금감면권 (tax_exemption)**: 월말 세금 감면 효과
> * **이체수수료감면권 (transfer_fee_reduction)**: 이체 수수료 감면 효과
> * **금고 등급 (vault_subscription)**: 금고 이용 등급 (한도, 이자율, 혜택)
> <a:DH_MINA_03:1462813029577130200> 효과 비율(%) 설정으로 감면 정도 조절 가능

> ### <a:DH_MINA_03:1462813029577130200> 기본 아이템 시딩
> * **인벤토리형**: 경고차감권, 활동부스트권, 색상선택권 등 소모성
> * **역할지급형**: 프리미엄잠수방, VIP라운지 등 기간제
> <a:DH_MINA_03:1462813029577130200> "기본 아이템 추가" 버튼으로 일괄 추가 가능

---

> ## 2단계: 가격 및 화폐 설정
> ### <a:DH_MINA_03:1462813029577130200> 화폐 종류 선택
> * **topy (활동형 화폐)**: 채팅/음성 활동으로 획득
> * **ruby (수익형 화폐)**: 결제/장터 거래로 획득
> * **both (둘 다)**: 두 화폐 모두로 구매 가능
> <a:DH_MINA_03:1462813029577130200> 화폐 종류에 따라 해당 상점 패널에 표시

> ### <a:DH_MINA_03:1462813029577130200> 가격 설정
> ```- 토피 가격: 활동형 화폐로 구매 시 가격
> - 루비 가격: 수익형 화폐로 구매 시 가격
> - 화폐 타입이 "both"인 경우 두 가격 모두 설정```

---

> ## 3단계: 역할선택권 설정
> ### <a:DH_MINA_03:1462813029577130200> 역할선택권 프리셋
> * **1회 사용권 (once)**: 한 번 사용 시 역할 영구 부여 (1개 소모)
> * **기간권 (period)**: 유효기간 동안 자유 변경, 만료 시 역할 제거 (0개 소모)
> <a:DH_MINA_03:1462813029577130200> 프리셋에 따라 소모 개수가 자동 설정됨

> ### <a:DH_MINA_03:1462813029577130200> 역할 옵션 구성
> * **고정 역할**: 모든 선택에 함께 부여되는 메인 역할
> * **교환 가능 역할**: 유저가 선택할 수 있는 역할 목록
> * **이전 역할 제거**: 역할 변경 시 이전 역할 자동 제거 여부
> <a:DH_MINA_03:1462813029577130200> 역할이 설정되지 않은 아이템은 활성화 불가

---

> ## 4단계: 금고 등급 설정 (vault_subscription)
> ### <a:DH_MINA_03:1462813029577130200> 기본 설정
> * **등급명 (tierName)**: 유저에게 표시되는 등급 이름 (실버, 골드 등)
> * **금고 한도 (vaultLimit)**: 금고에 보관 가능한 최대 금액
> * **월 이자율 (monthlyInterestRate)**: 매월 지급되는 이자율 (%)
> * **최소 예치 기간 (minDepositDays)**: 이자를 받기 위한 최소 예치 일수
> * **구독 기간 (durationDays)**: 구매 시 적용되는 구독 기간

> ### <a:DH_MINA_03:1462813029577130200> 수수료 혜택
> * **이체수수료 면제 (transferFeeExempt)**: 이체 수수료 면제 여부
> * **구매수수료 (purchaseFeePercent)**: 상점 구매 시 적용되는 수수료율 (0 = 면제)

---

> ## 5단계: 재고 및 제한 설정
> ### <a:DH_MINA_03:1462813029577130200> 수량 제한
> * **재고 (stock)**: 전체 판매 가능 수량 (비워두면 무제한)
> * **유저당 최대 (maxPerUser)**: 1인당 구매 가능 수량 (비워두면 무제한)
> * **유효 기간 (durationDays)**: 구매 후 아이템 만료까지의 일수 (0 = 무기한)
> <a:DH_MINA_03:1462813029577130200> 금고등급/기간권은 반드시 유효기간 설정 필요

---

> ## 6단계: 상점 패널 설치
> ### <a:DH_MINA_03:1462813029577130200> 통합 상점 패널
> 1. **채널 선택**: 패널을 설치할 텍스트 채널 지정
> 2. **설치 버튼 클릭**: 선택한 채널에 패널 메시지 생성
> 3. **갱신/교체**: 다른 채널 선택 후 설치 시 기존 패널 삭제 후 재생성
> ```- 토피/루비 상점을 버튼으로 전환하는 통합 패널
> - 유저는 버튼 클릭으로 상점 UI 접근 가능```

---

> ## 7단계: 상점 수수료 설정
> ### <a:DH_MINA_03:1462813029577130200> 수수료 구성
> * **토피 상점 수수료 (%)**: 토피로 구매 시 부과되는 수수료율
> * **루비 상점 수수료 (%)**: 루비로 구매 시 부과되는 수수료율
> <a:DH_MINA_03:1462813029577130200> 수수료는 상품 가격에 추가로 부과됨 (0% = 수수료 없음)

---

> ## 8단계: 봇 상점 패널 동작
> ### <a:DH_MINA_03:1462813029577130200> 상점 패널 버튼
> * **토피 상점**: 토피로 구매 가능한 아이템 목록 표시
> * **루비 상점**: 루비로 구매 가능한 아이템 목록 표시
> <a:DH_MINA_03:1462813029577130200> 버튼 클릭 시 ephemeral 메시지로 상점 UI 표시

> ### <a:DH_MINA_03:1462813029577130200> 아이템 구매 프로세스
> ```처리 흐름:
> 1. 상점 패널에서 아이템 선택
> 2. 수량 선택 UI 표시 (1~5개)
> 3. 잔액/재고/유저당 제한 확인
> 4. 수수료 계산 → 결제 처리
> 5. 인벤토리에 아이템 추가
> 6. 구매 완료 메시지 표시```

> ### <a:DH_MINA_03:1462813029577130200> 역할선택권 사용
> ```처리 흐름:
> 1. 인벤토리에서 역할선택권 클릭
> 2. 교환 가능 역할 목록 표시
> 3. 역할 선택 시 소모 개수 차감 (1회 사용권)
> 4. 고정 역할 자동 부여 (첫 사용 시)
> 5. 선택한 역할 부여 (이전 역할 제거 옵션 적용)```

> ### <a:DH_MINA_03:1462813029577130200> 금고 등급 구매
> * 구매 즉시 금고 이용 권한 활성화
> * 구독 기간 동안 금고 한도/이자율 적용
> * 이체수수료 면제 혜택 자동 적용
> * 만료 시 금고 접근 불가 (예치금은 유지)

---

> ## 9단계: 인벤토리 명령어
> ### <a:DH_MINA_03:1462813029577130200> `/인벤토리` 명령어
> * 보유한 아이템 목록을 페이지 형태로 조회
> * 각 아이템의 수량, 만료일, 상태 표시
> * 아이템별 역할 교환 버튼 제공
> ```표시 정보:
> - 아이템 이름 및 설명
> - 보유 수량 / 만료일
> - 역할 선택 가능 여부```

> ### <a:DH_MINA_03:1462813029577130200> 역할 교환 기능
> ```처리 흐름:
> 1. 인벤토리에서 역할선택권 클릭
> 2. 선택 가능한 역할 목록 표시 (SelectMenu)
> 3. 역할 선택 시:
>    - 1회 사용권: 수량 1개 차감 + 역할 영구 부여
>    - 기간권: 수량 유지 + 역할 기간제 부여
> 4. 이전 역할 제거 옵션 적용
> 5. 고정 역할 자동 부여 (첫 사용 시)```
> <a:DH_MINA_03:1462813029577130200> 역할 교환 시 이전 역할 자동 제거 가능

---

> ## 10단계: 만료 아이템 스케줄러
> ### <a:DH_MINA_03:1462813029577130200> 스케줄러 동작
> * **실행 주기**: 1시간마다 자동 체크
> * **처리 대상**: 유효기간이 만료된 아이템 및 역할 효과
> <a:DH_MINA_03:1462813029577130200> 봇 시작 시 즉시 1회 실행

> ### <a:DH_MINA_03:1462813029577130200> 아이템 만료 처리
> ```처리 흐름:
> 1. 만료된 아이템 조회 (expiresAt < 현재시간)
> 2. 부여된 역할 회수 (교환 역할 + 고정 역할)
> 3. 아이템 만료 상태로 변경
> 4. 유저에게 DM 알림 전송```

> ### <a:DH_MINA_03:1462813029577130200> 역할 효과 만료 처리
> * 아이템은 유지되고 역할 효과만 만료되는 경우
> * 기간권 역할이 만료되면 역할만 회수
> * 아이템은 인벤토리에 유지 (재선택 가능)
> <a:DH_MINA_03:1462813029577130200> DM 알림으로 만료 안내 및 재구매 유도

> ### <a:DH_MINA_03:1462813029577130200> DM 알림 내용
> ```알림 타입:
> - 아이템 만료: "아이템이 만료되어 역할이 회수되었습니다"
> - 역할 효과 만료: "역할 효과가 만료되었습니다. 인벤토리에서 다시 선택하세요"```

---

> ## 11단계: 인벤토리 관리 (웹 대시보드)
> ### <a:DH_MINA_03:1462813029577130200> 인벤토리 목록
> * 아이템을 보유한 유저 목록 조회
> * 유저 ID로 검색 가능
> * 보유 아이템 종류 수 표시
> <a:DH_MINA_03:1462813029577130200> 페이지네이션 지원 (20명 단위)

> ### <a:DH_MINA_03:1462813029577130200> 유저별 인벤토리 상세
> * 유저 클릭 시 상세 인벤토리 모달 표시
> * 아이템별 수량, 만료일, 역할 상태 표시
> <a:DH_MINA_03:1462813029577130200> 역할선택권 현재 선택 역할 표시

> ### <a:DH_MINA_03:1462813029577130200> 아이템 지급/회수 (웹)
> * 웹에서 직접 아이템 지급 가능
> * 유저 ID, 아이템 선택, 수량 입력
> * 회수 시 보유 아이템 목록에서 선택
> <a:DH_MINA_03:1462813029577130200> 봇 명령어(/아이템지급, /아이템회수)와 동일 기능

---

> ## <a:DH_MINA_05:1462814742178693160> 주의사항 및 제약
> ### 1. 역할선택권 아이템
> <a:DH_MINA_03:1462813029577130200> 역할(고정 또는 교환 역할)이 설정되지 않으면 활성화 불가
> ### 2. 시스템 아이템
> <a:DH_MINA_03:1462813029577130200> 타입 변경 불가 (생성 시 선택한 타입 유지)
> ### 3. 화폐 비활성화
> <a:DH_MINA_03:1462813029577130200> 해당 화폐가 비활성화되면 해당 화폐로 구매 불가
> ### 4. 봇 역할 권한
> <a:DH_MINA_03:1462813029577130200> 역할 부여를 위해 봇 역할이 부여할 역할보다 높아야 함

---

> ### <a:DH_MINA_13:1462814948127146005> 요약
> - 1. **다양한 아이템 타입**: 일반, 세금감면권, 이체감면권, 금고등급 등
> - 2. **역할선택권**: 1회 사용권/기간권 프리셋으로 역할 교환 기능
> - 3. **금고 등급**: 한도, 이자율, 혜택 등 세부 설정 가능
> - 4. **통합 패널**: 디스코드 채널에 상점 버튼 패널 설치
> - 5. **수수료 설정**: 화폐별 상점 수수료 개별 설정
> - 6. **봇 구매 프로세스**: 수량 선택, 결제, 인벤토리 추가 자동 처리
> - 7. **역할 자동 부여**: 역할선택권 사용 시 봇이 역할 자동 부여
> - 8. **인벤토리 명령어**: /인벤토리로 보유 아이템 조회 및 역할 교환
> - 9. **만료 스케줄러**: 1시간마다 만료 아이템 체크 및 역할 회수
> - 10. **DM 알림**: 아이템/역할 만료 시 개인 DM 발송
> - 11. **인벤토리 관리**: 유저별 인벤토리 조회/지급/회수 (웹 대시보드)
