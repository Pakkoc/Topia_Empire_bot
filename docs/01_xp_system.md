# XP/레벨링 시스템 기획서

## 1. 시스템 개요

| 항목 | 내용 |
|------|------|
| 목적 | 디스코드 서버 활동에 따라 XP를 부여하고, 레벨업과 보상으로 참여도 향상 |
| 연동 방식 | 디스코드 봇 + 웹 대시보드 |
| 대상 사용자 | 서버 관리자 및 일반 유저 |

### 지원 기능
- 텍스트 및 음성 XP 관리
- 레벨업 및 보상 시스템
- 웹 대시보드를 통한 직관적 설정

---

## 2. 핵심 기능

### 2-1. XP 부여

| 기능 | 설명 | 설정 옵션 |
|------|------|-----------|
| 텍스트 XP | 채팅 메시지 기반 경험치 부여 | N XP, N분마다 최대 N회 획득, 핫타임 설정 |
| 음성 XP | 음성 채널 활동 기반 경험치 부여 | N XP, N분마다 최대 N회 획득, 핫타임 설정 |
| XP 차단 채널 | XP를 받을 수 없는 채널 지정 | 채널 선택 |
| XP 차단 역할 | XP를 받을 수 없는 역할 지정 | 역할 선택 (예: 미인증 유저) |

### 2-2. 레벨업 시스템

| 기능 | 설명 | 설정 옵션 |
|------|------|-----------|
| 레벨업 조건 | 레벨 달성 기준 XP 설정 | 레벨당 N XP 필요 |
| 레벨업 알림 | 레벨업 시 채널에 알림 발송 | 알림 채널 지정 |
| 레벨업 보상 | 레벨 달성 시 역할 부여/제거 | 이전 역할 유지 여부 선택, 역할 지정 |
| 해금 채널 | 특정 레벨 달성 시 접근 가능한 채널 | 채널 선택 |

### 2-3. XP 핫타임

| 기능 | 설명 | 설정 옵션 |
|------|------|-----------|
| 텍스트 XP 핫타임 | 특정 시간대 텍스트 XP 배율 증가 | 시작 시간, 종료 시간, 배율, 쿨다운 |
| 음성 XP 핫타임 | 특정 시간대 음성 XP 배율 증가 | 시작 시간, 종료 시간, 배율, 쿨다운 |

---

## 3. 웹 대시보드 UI 설계

### 3-1. 좌측 메뉴 구조

```
Dashboard
└── XP / Level System
    ├── 텍스트 XP 설정
    ├── 음성 XP 설정
    ├── XP 핫타임
    ├── XP 차단 채널/역할
    ├── 레벨업 / 보상
    ├── 레벨별 보상 설정
    ├── 레벨업 알림 채널
    ├── 해금 채널
    └── Logs / 통계
```

### 3-2. 주요 UI 화면

#### XP 설정 화면
- 텍스트 XP: 입력창(N XP), 쿨다운(N분), 최대 획득 횟수
- 음성 XP: 입력창(N XP), 쿨다운(N분), 최대 획득 횟수
- XP 핫타임 ON/OFF, 시간 선택, 배율 선택

#### XP 차단 화면
- 채널 선택 체크박스
- 역할 선택 체크박스

#### 레벨업 설정 화면
- 레벨별 필요 XP 입력
- 레벨업 알림 채널 선택
- 레벨별 보상 역할 선택 + 이전 역할 제거 여부

#### 해금 채널 화면
- 특정 레벨 달성 시 접근 가능 채널 체크

### 3-3. 알림/로그
- 레벨업 이벤트 발생 시 대시보드 알림 기록
- XP 획득 통계, 레벨업 유저 통계

---

## 4. 데이터 구조

### 4-1. 유저 XP 테이블 (`user_xp`)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| guild_id | VARCHAR(20) | 서버 ID |
| user_id | VARCHAR(20) | 디스코드 유저 ID |
| level | INT | 현재 레벨 |
| xp | INT | 현재 XP |
| last_text_xp_at | DATETIME | 텍스트 XP 마지막 획득 시간 |
| last_voice_xp_at | DATETIME | 음성 XP 마지막 획득 시간 |

### 4-2. XP 설정 테이블 (`xp_settings`)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| guild_id | VARCHAR(20) | 서버 ID (PK) |
| text_xp | INT | 메시지당 XP |
| text_cooldown | INT | 텍스트 XP 쿨다운 (초) |
| text_max_per_cooldown | INT | 쿨다운 내 최대 획득 횟수 |
| voice_xp | INT | 음성 XP |
| voice_cooldown | INT | 음성 XP 쿨다운 (초) |
| voice_max_per_cooldown | INT | 음성 쿨다운 내 최대 획득 |
| level_up_channel_id | VARCHAR(20) | 레벨업 알림 채널 |

### 4-3. 핫타임 설정 테이블 (`xp_hot_time`)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | INT | PK |
| guild_id | VARCHAR(20) | 서버 ID |
| type | ENUM('text', 'voice') | 텍스트/음성 구분 |
| start_time | TIME | 핫타임 시작 |
| end_time | TIME | 핫타임 종료 |
| multiplier | DECIMAL(3,2) | XP 배율 |
| enabled | BOOLEAN | 활성화 여부 |

### 4-4. XP 차단 테이블 (`xp_exclusions`)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | INT | PK |
| guild_id | VARCHAR(20) | 서버 ID |
| type | ENUM('channel', 'role') | 채널/역할 구분 |
| target_id | VARCHAR(20) | 채널 또는 역할 ID |

### 4-5. 레벨 보상 테이블 (`level_rewards`)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | INT | PK |
| guild_id | VARCHAR(20) | 서버 ID |
| level | INT | 보상 레벨 |
| role_id | VARCHAR(20) | 부여할 역할 ID |
| remove_previous | BOOLEAN | 이전 역할 제거 여부 |

### 4-6. 해금 채널 테이블 (`level_unlock_channels`)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | INT | PK |
| guild_id | VARCHAR(20) | 서버 ID |
| level | INT | 해금 레벨 |
| channel_id | VARCHAR(20) | 해금할 채널 ID |

---

## 5. 기능 플로우

```
1. 유저 활동 감지 (채팅/음성)
           ↓
2. XP 지급 조건 체크
   ├── 채널/역할 제외 여부
   ├── 쿨다운 체크
   └── 핫타임 적용
           ↓
3. XP 추가
           ↓
4. 레벨업 조건 충족 시
   ├── 레벨업 처리
   ├── 보상 역할 부여/제거
   ├── 레벨업 알림 전송
   └── 해금 채널 접근 허용
           ↓
5. 대시보드에서 설정 값 즉시 반영 (Redis Pub/Sub)
```

---

## 6. 기본 설정값 (프로봇 기준)

| 항목 | 기본값 |
|------|--------|
| 텍스트 XP | 15~25 XP |
| 텍스트 쿨다운 | 60초 |
| 음성 XP | 10~20 XP |
| 음성 쿨다운 | 60초 |
| 레벨업 공식 | `5 * (level^2) + 50 * level + 100` |
